# å¼€å‘è€…æŒ‡å—

&emsp;&emsp;æœ¬ç« ä¸­æˆ‘ä»¬å°†ç®€å•ä»‹ç»å¦‚ä½•ä¸º swpp è¿›è¡Œå¹³å°é€‚é…ã€‚

## ä¾èµ–å®‰è£…

&emsp;&emsp;åœ¨ `package.json` çš„ `dependencies` ä¸­æ·»åŠ  `swpp-backends` çš„ä¾èµ–å³å¯å®Œæˆä¾èµ–çš„å®‰è£…ã€‚

&emsp;&emsp;ä½†æ˜¯è¿™ç§æ–¹æ³•åœ¨ `swpp-backends` æ›´æ–°æ—¶ï¼Œå¹³å°å®ç°ä¹Ÿéœ€è¦åŒæ­¥æ›´æ–°ï¼Œä½¿ç”¨èµ·æ¥ä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬æ¨èä½¿ç”¨ `peerDependencies`ã€‚

+ [NPM æ–‡æ¡£](https://docs.npmjs.com/cli/v10/configuring-npm/package-json#peerdependencies)
+ [çŸ¥ä¹ä¸­æ–‡ä»‹ç»](https://zhuanlan.zhihu.com/p/666454541)

## å¹³å°é€‚é…

&emsp;&emsp;swpp å·²ç»å°è£…äº†å¤§éƒ¨åˆ†ä»£ç ï¼Œè¿›è¡Œé€‚é…æ—¶åªéœ€è¦çº¿æ€§è°ƒç”¨æ¥å£å³å¯ï¼Œæ‚¨å¯ä»¥å‚è€ƒ `swpp-backends` ä¸­çš„ `cli.ts` å’Œ `hexo-swpp` çš„ä»£ç ã€‚

&emsp;&emsp;æ’ä»¶å¿…è¦çš„åˆå§‹åŒ–éƒ¨åˆ†æŒ‰ç…§å¦‚ä¸‹æµç¨‹è¿›è¡Œï¼ˆéƒ¨åˆ†æµç¨‹ä¹‹é—´æ— å…ˆåé¡ºåºï¼‰ï¼š

1. åˆå§‹åŒ– `swpp-backends` çš„é…ç½®ï¼ˆ`ConfigLoader`ï¼‰
2. æ‰«æç½‘ç«™çš„èµ„æºï¼ˆ`ResourcesScanner`ï¼‰
3. ç”Ÿæˆ sw æ–‡ä»¶
4. å¿…è¦æ—¶ä¿®æ”¹å·²æœ‰çš„ HTML æ–‡ä»¶
5. å°†ç”Ÿæˆçš„å†…å®¹å†™å…¥åˆ°æŒ‡å®šä½ç½®

&emsp;&emsp;é€šå¸¸æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ `BasicActions` ç±»ï¼Œè¯¥ç±»ä¸­å·²ç»ä¸ºæ‚¨å°è£…äº†é€šç”¨çš„æ„å»ºæµç¨‹ï¼š

```typescript
import {BasicActions} from 'swpp-backends'

// å…¶ä¸­çš„è·¯å¾„å‡ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•
const actions = await BasicActions.build(
    'dev',            // ç¯å¢ƒç±»å‹ï¼Œå¡« 'dev' æˆ– 'prod'
    '<public path>',  // ç½‘ç«™çš„æ ¹ç›®å½•
    true,             // æ˜¯å¦ç”Ÿæˆ sw.js
    '<dom js path>',  // DOM JS çš„ç”Ÿæˆç›®å½•ï¼Œç•™ç©ºè¡¨ç¤ºä¸ç”Ÿæˆ
    '<diff json path>'// diff json çš„ç”Ÿæˆç›®å½•ï¼Œç•™ç©ºè¡¨ç¤ºä¸ç”Ÿæˆ
)

// åŠ è½½é…ç½®æ–‡ä»¶
await actions.loadConfig('<config js/ts path>')
// æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä»ä»£ç ä¸­åŠ è½½
// await actions.loadConfig({xxx})
// æˆ–æ‰¹é‡åŠ è½½
// await actions.loadConfigs([{}, '<config1 js/ts path>', xxx])

// æ„å»ºé…ç½®
actions.buildConfig()

// æ„å»ºæ–‡ä»¶
await actions.buildFiles()
```

&emsp;&emsp;æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦åœ¨å‡½æ•°è°ƒç”¨å‰åæ·»åŠ æ‚¨çš„ä»£ç ï¼Œä»¥å®ç°æ›´å¤æ‚çš„åŠŸèƒ½ã€‚å¦‚æœ `BasicActions` æ— æ³•æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç»•è¿‡ `BasicActions` å®Œå…¨è‡ªå·±ç¼–å†™ä»£ç ã€‚

&emsp;&emsp;ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸‹å¸¸ç”¨çš„ä¸€äº›æ¥å£ï¼š

### åŠ è½½ swpp é…ç½®

&emsp;&emsp;åŠ è½½é…ç½®ç›¸å½“ç®€å•ï¼Œ`swpp-backends` å·²ç»å°†æ‰€æœ‰æ“ä½œå°è£…åˆ°äº† `ConfigLoader` å½“ä¸­ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç å³å¯å®šä¹‰ä¸€ä¸ªåŠ è½½å™¨ï¼š

```typescript
import {ConfigLoader} from 'swpp-backends'

// noinspection JSUnusedLocalSymbols
const loader = new ConfigLoader();
```

&emsp;&emsp;è°ƒç”¨ `ConfigLoader#load` å³å¯è¯»å–æŒ‡å®šé…ç½®ï¼Œå‚æ•°ä¸ºé…ç½®æ–‡ä»¶ï¼ˆjs æˆ– tsï¼‰çš„ç»å¯¹è·¯å¾„ï¼Œè¶Šæ—©è¢«åŠ è½½çš„é…ç½®é¡¹ä¼˜å…ˆçº§è¶Šé«˜ã€‚

&emsp;&emsp;æœ‰äº›æ—¶å€™ï¼Œæ‚¨å¯èƒ½æƒ³è¦ç›´æ¥ä»ä»£ç ä¸­è®¾ç½®ä¸€äº›é…ç½®ï¼Œåˆ™å¯ä»¥è°ƒç”¨ `ConfigLoader#loadFromCode` å‡½æ•°ï¼Œè¯¥å‡½æ•°åŠ è½½çš„é…ç½®çš„ä¼˜å…ˆçº§åŒæ ·å–å†³äºè°ƒç”¨é¡ºåºã€‚å¦‚æœæ··ç”¨ä¸¤ç§åŠ è½½æ–¹å¼ï¼Œä¹Ÿæ˜¯å…ˆè°ƒç”¨çš„ç”Ÿæ•ˆã€‚

&emsp;&emsp;ä¸‹é¢ï¼Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªç¤ºä¾‹ï¼š

```typescript
import {ConfigLoader, AllowNotFoundEnum} from 'swpp-backends'

const loader = new ConfigLoader();
await loader.loadFromCode({
    compilationEnv: {
        DOMAIN_HOST: new URL('http://localhost:8080'),
        PUBLIC_PATH: 'publish/'
    }
})
/*
  example.ts:
  import {AllowNotFoundEnum, defineConfig} from 'swpp-backends'
  defineConfig({
      compilationEnv: {
          DOMAIN_HOST: new URL('https://example.com'),
          ALLOW_NOT_FOUND: AllowNotFoundEnum.ALLOW_ALL
      }
  })
 */
await loader.load('config/example.ts')
await loader.loadFromCode({
    compilationEnv: {
        ALLOW_NOT_FOUND: AllowNotFoundEnum.REJECT_ALL
    }
})
```

&emsp;&emsp;æœ€ç»ˆç”Ÿæ•ˆçš„é…ç½®ä¸ºï¼š

```typescript
import {AllowNotFoundEnum, defineConfig} from 'swpp-backends'

defineConfig({
    compilationEnv: {
        DOMAIN_HOST: new URL('http://localhost:8080'),
        PUBLIC_PATH: 'publish/',
        ALLOW_NOT_FOUND: AllowNotFoundEnum.ALLOW_ALL
    }
})
```

### è¯»å– swpp é…ç½®

&emsp;&emsp;æ‚¨æˆ–è®¸ç»å¸¸éœ€è¦è¯»å– swpp é…ç½®ï¼Œä»¥æ­¤å†³å®šæ‚¨æ˜¯å¦æ‰§è¡ŒæŸä¸ªæ“ä½œæˆ–å…¶å®ƒäº‹æƒ…ã€‚

&emsp;&emsp;å½“æ‚¨ä½¿ç”¨ `ConfigLoader` åŠ è½½é…ç½®åï¼Œå¯ä»¥è°ƒç”¨ `generate` å‡½æ•°ç”Ÿæˆæœ€ç»ˆçš„é…ç½®é¡¹ã€‚`generate` å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å« `compilation` å’Œ `runtime` ä¸¤ä¸ªå­—æ®µï¼Œå‰è€…æ˜¯æ„å»ºæœŸå¯è¯»çš„é…ç½®ï¼Œåè€…æ˜¯è¿è¡Œæ—¶å¯è¯»çš„é…ç½®ã€‚è¿™ä¸¤ä¸ªå­—æ®µä¸­ä¼šåŒ…å«è‹¥å¹²ä¸ª `KeyValueDatabase`ï¼Œé€šè¿‡è°ƒç”¨ `KeyValueDatabase` çš„ `read` å‡½æ•°å³å¯è¯»å–æŒ‡å®šé…ç½®ã€‚

&emsp;&emsp;æ¨èæ‚¨ä½¿ç”¨å…·æœ‰å®Œæ•´ç±»å‹æ¨å¯¼å’Œè‡ªåŠ¨è¡¥å…¨çš„ IDEï¼ˆæˆ–ç¼–è¾‘å™¨ï¼‰ï¼Œæ¯”å¦‚ WebStormã€vscode ç­‰ã€‚å› ä¸º swpp ä¸ºé…ç½®é¡¹æ·»åŠ äº†å¤æ‚çš„æ•°æ®ç±»å‹ï¼ˆå¯èƒ½ä¼šéš¾ä»¥é˜…è¯»ï¼‰ï¼ŒIDE å¯ä»¥é€šè¿‡è¿™äº›ç±»å‹ä¸ºæ‚¨æä¾›è‡ªåŠ¨è¡¥å…¨å’Œé™æ€æ£€æŸ¥ï¼Œä»¥å¸®åŠ©æ‚¨è·å–åˆ°æ›´ä½³çš„å¼€å‘ä½“éªŒã€‚

&emsp;&emsp;æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¸€ä¸ªğŸŒ°ï¼š

```typescript
// noinspection TypeScriptUnresolvedReference,JSUnusedLocalSymbols

import {ConfigLoader} from 'swpp-backends'

// æˆ‘ä»¬å‡è®¾æ‚¨å·²ç»æœ‰äº†ä¸€ä¸ª ConfigLoader
let loader: ConfigLoader
const {runtime, compilation} = loader.generate()

// é€šè¿‡è¿™ä¸ªä»£ç æ‚¨å¯ä»¥è¯»å– CrossDep åˆ†æ”¯ä¸‹çš„ matchCacheRule é…ç½®
// å½“ç„¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ compilation.crossDep ä»£æ›¿ runtime.crossDepï¼Œè¿™ä¸¤è€…æŒ‡å‘åŒä¸€å¯¹è±¡
runtime.crossDep.read('matchCacheRule')
```

### æ‰«æç½‘ç«™èµ„æº

&emsp;&emsp;swpp å°†èµ„æºæ‰«æçš„æ“ä½œå°è£…åˆ°äº† `ResourcesScanner` ç±»ä¸­ï¼Œåˆ›å»ºè¯¥ç±»çš„å¯¹è±¡å¹¶è°ƒç”¨å…¶ä¸­çš„ `scanLocalFile` å‡½æ•°å³å¯å®Œæˆèµ„æºçš„æ‰«æï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•æˆ–ç»å¯¹è·¯å¾„ï¼‰ï¼Œè¯¥è·¯å¾„åº”å½“æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª `FileUpdateTracker` å¯¹è±¡ï¼Œè¯¥å¯¹è±¡è®°å½•äº†æ‰«æçš„ç»“æœï¼Œé™¤éæ‚¨çŸ¥é“æ‚¨åœ¨å¹²ä»€ä¹ˆï¼Œå¦åˆ™ä¸è¦ä¿®æ”¹è¿™ä¸ªå¯¹è±¡çš„å†…å®¹ã€‚

&emsp;&emsp;è°ƒç”¨ `FileUpdateTracker` çš„ `diff` å‡½æ•°å³å¯è·å–åˆ°å½“å‰æœ¬åœ°çš„æ–‡ä»¶ä¸ä¸Šä¸€æ¬¡æ„å»ºæ—¶çš„å·®å¼‚ï¼Œè°ƒç”¨å swpp å°†è‡ªåŠ¨ä»ç½‘ç»œæ‹‰å–ä¸Šä¸€æ¬¡æ„å»ºçš„ç»“æœã€‚è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª `JsonBuilder` å¯¹è±¡ï¼Œé™¤éæ‚¨çŸ¥é“æ‚¨åœ¨å¹²ä»€ä¹ˆï¼Œå¦åˆ™ä¸è¦ä¿®æ”¹è¿™ä¸ªå¯¹è±¡çš„å†…å®¹ã€‚

&emsp;&emsp;è°ƒç”¨ `JsonBuilder` çš„ `buildJson` å‡½æ•°ï¼Œå³å¯ç”Ÿæˆæœ¬æ¬¡æ„å»ºçš„ç‰ˆæœ¬æ–‡ä»¶ï¼Œé€šè¿‡ `JSON.stringify` å‡½æ•°å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚

&emsp;&emsp;è°ƒç”¨ `FileUpdateTracker` çš„ `json` å‡½æ•°å¯ä»¥è·å–åˆ°æœ¬æ¬¡æ„å»ºçš„è·Ÿè¸ªå™¨ï¼ˆ`tracker`ï¼‰çš„ json åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«ä¸‹ä¸€æ¬¡æ„å»ºæ—¶éœ€è¦é‡å»ºçš„ä¿¡æ¯ï¼Œ`diff` å‡½æ•°å¼ºä¾èµ–ä¸Šä¸€æ¬¡æ„å»ºç”Ÿæˆçš„ `tracker` çš„ jsonã€‚

&emsp;&emsp;å¦‚æœæ‚¨æƒ³è¦å°†æœ¬æ¬¡æ„å»ºä¸ä¸Šæ¬¡æ„å»ºçš„æ–‡ä»¶å·®å¼‚å¯¼å‡ºåˆ°æ–‡ä»¶ï¼Œå¯ä»¥è°ƒç”¨ `JsonBuilder#serialize` å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†æ„å»ºå™¨çš„æ•°æ®åºåˆ—åŒ–ä¸º json å­—ç¬¦ä¸²ã€‚

&emsp;&emsp;æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¸€ä¸ªç¤ºä¾‹ï¼š

```typescript
// noinspection TypeScriptUnresolvedReference

import {ConfigLoader, ResourcesScanner} from 'swpp-backends'

// æˆ‘ä»¬å‡è®¾æ‚¨å·²ç»æœ‰äº†ä¸€ä¸ª ConfigLoader
let loader: ConfigLoader

async function scannerAndGenerate() {
    const {compilation} = loader.generate()
    const scanner = new ResourcesScanner(compilation)
    const tracker = await scanner.scanLocalFile('public')
    const jsonBuilder = await tracker.diff()
    const versionJson = jsonBuilder.buildJson()
    const trackerJson = tracker.json()
    return {versionJson, trackerJson}
}

const {versionJson, trackerJson} = await scannerAndGenerate()
// do somethings...
```

### æ„å»º SW JS

&emsp;&emsp;`SwCompiler` ç±»ç”¨äºæ„å»º sw æ–‡ä»¶ï¼Œåˆ›å»º `SwCompiler` çš„å¯¹è±¡å¹¶è°ƒç”¨ `buildSwCode` å‡½æ•°å°±èƒ½ç”Ÿæˆ sw æ–‡ä»¶çš„ js ä»£ç å­—ç¬¦ä¸²ã€‚

### æ„å»º DOM JS

&emsp;&emsp;æ„å»º dom js çš„æ“ä½œç›¸å¯¹æ¯”è¾ƒç‰¹æ®Šï¼Œdom js çš„å†…å®¹è¢«ä¿å­˜åˆ°äº† `domConfig` ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ª `KeyValueDatabase`ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªç”¨äºæ„å»ºæºä»£ç çš„å‡½æ•°ï¼š

1. `buildJsSource` - è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå®Œæ•´çš„ JS æ–‡ä»¶çš„å­—ç¬¦ä¸²ï¼Œå¤–éƒ¨ä½¿ç”¨ `DOMContentLoaded` äº‹ä»¶åŒ…è£¹ã€‚
2. `buildInnerSource` - è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª JS ä»£ç çš„å­—ç¬¦ä¸²ï¼Œå†…å®¹æ˜¯ `buildJsSource` çš„äº‹ä»¶å†…çš„ä»£ç ï¼Œé€šå¸¸ä½¿ç”¨ä¸Šè€…å³å¯ã€‚

### å†™å…¥æ–‡ä»¶

&emsp;&emsp;æ ¹æ®ä¸åŒå¹³å°ï¼Œæ‚¨éœ€è¦è‡ªè¡Œå†³å®šä½¿ç”¨ä»€ä¹ˆæ–¹æ³•å°† swpp ç”Ÿæˆçš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚

&emsp;&emsp;ä¸‹é¢æ˜¯å„ä¸ªæ–‡ä»¶å†™å…¥çš„è·¯å¾„çš„è¯»å–æ–¹å¼ï¼š

```typescript
// noinspection TypeScriptUnresolvedReference

import nodePath from 'path'
import {ConfigLoader, SwCompiler, UpdateJson} from 'swpp-backends'

// å‡è®¾å·²ç»æœ‰äº†éœ€è¦çš„æ‰€æœ‰æ•°æ®
let loader: ConfigLoader
const {runtime, compilation} = loader.generate()
let versionJson: UpdateJson
let trackerJson: string
let swJsCode = new SwCompiler()
const jsonInfo = compilation.compilationEnv.read('SWPP_JSON_FILE')
const publicRoot = compilationData.compilationEnv.read('PUBLIC_PATH')

// ç‰ˆæœ¬æ–‡ä»¶çš„å†…å®¹
const versionJsonText = JSON.stringify(versionJson)
// tracker æ–‡ä»¶çš„å†…å®¹
const trackerJsonText = trackerJson
// sw æ–‡ä»¶çš„å†…å®¹
const swJsText = swJsCode.buildSwCode(runtime)
// dom js æ–‡ä»¶çš„å†…å®¹
const domJsText = runtime.domConfig.buildJsSource()

// ç‰ˆæœ¬æ–‡ä»¶çš„è·¯å¾„
const versionJsonPath = nodePath.join(publicRoot, jsonInfo.swppPath, jsonInfo.versionPath)
// tracker æ–‡ä»¶çš„è·¯å¾„
const trackerJsonPath = nodePath.join(publicRoot, jsonInfo.swppPath, jsonInfo.trackerPath)
// sw æ–‡ä»¶çš„è·¯å¾„
const swJsPath = nodePath.join(publicRoot, compilation.compilationEnv.read('SERVICE_WORKER') + '.js')
// dom js æ–‡ä»¶çš„è·¯å¾„
const domJsPath = nodePath.join(publicRoot, '<è¿™é‡Œè‡ªå®šä¹‰>.js')
// diff æ–‡ä»¶ï¼ˆæ„å»ºå™¨çš„åºåˆ—åŒ–ç»“æœï¼‰çš„è·¯å¾„å®Œå…¨æœ‰æ‚¨è‡ªå·±æŠŠæ§ï¼Œswpp ä¸ä¼šä¾èµ–è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹
```